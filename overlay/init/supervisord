#!/bin/bash

[[ ${DOCKER_DEBUG:-} ]] && set -x

die () {
  echo "ERROR: ${1}"
  exit 1
}

# PID, trap, wait; all belongs to 'docker stop' signal handeling.
# This is the same logic as the parent docker container, but rather this,
# than creating a one-time process in supervisord to handle this logic.
PID=; trap '[[ ${PID} ]] && kill ${PID}; exit 0' SIGTERM

supervisord_pre=$(ls /hooks/supervisord-pre.d/* 2>/dev/null | sort -n )
if [ "$supervisord_pre" != "" ]; then
  for hook in $supervisord_pre; do
    echo "Executing hook ${hook}"
    /bin/bash -c "${hook}"
    hook_exit=$?
    if [ "$hook_exit" != "0" ]; then
      die "hook ${hook} returned a non-zero exit status '$hook_exit'"
    fi
  done
fi

[[ -f "/hooks/supervisord-pre" ]] && echo "The /hooks/supervisord-pre hook has been replaced with /hooks/supervisord-pre.d/*" && exit 1

echo "Validating nginx configuration..."
if ! nginx -t 2>&1; then
  die "nginx configuration test failed - check config files"
fi

echo "Starting Supervisord"
echo "NOTE: 'Starting Supervisord' is the expected final startup message."
echo "      The container is now running. Check container health status or logs for activity."

exec /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf -e ${SUPERVISORD_LOGLEVEL:-error}
