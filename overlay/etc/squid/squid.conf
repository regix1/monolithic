# Squid SSL Bump Configuration for LanCache
# This configuration enables HTTPS interception and caching
# Only active when ENABLE_SSL_BUMP=true

# Access control - allow RFC1918 private networks
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

# ACL for domains to SSL bump (loaded from cache-domains)
acl bump_domains ssl::server_name "/etc/squid/bump-domains.txt"

# ACL for domains that failed SSL bump (certificate pinning, etc.)
# These will be spliced (passed through) instead of bumped
acl splice_domains ssl::server_name "/etc/squid/splice-domains.txt"

# Deny requests to non-safe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow local networks
http_access allow localnet
http_access allow localhost
http_access deny all

# HTTP port for receiving decrypted traffic from nginx stream
http_port 3129 ssl-bump \
    cert=/data/ssl/lancache-ca.pem \
    key=/data/ssl/lancache-ca.key \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=64MB

# SSL certificate generation helper (path varies by distro)
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 64MB
sslcrtd_children 8 startup=1 idle=1

# SSL Bump rules:
# Step 1: Peek at the SNI to see the domain
acl step1 at_step SslBump1
# Step 2: Stare at the server certificate
acl step2 at_step SslBump2

# Peek at all connections first to read the SNI
ssl_bump peek step1

# Splice (pass through) domains that have failed SSL bump before
ssl_bump splice splice_domains

# Stare at server cert for domains we want to bump
ssl_bump stare step2 bump_domains

# Bump (decrypt) domains in our cache list
ssl_bump bump bump_domains

# Splice (pass through without decryption) everything else
ssl_bump splice all

# On SSL errors, splice instead of terminating
# This allows connections to continue even if bumping fails
on_unsupported_protocol tunnel all

# Don't cache in Squid - let nginx handle caching
# Squid just decrypts and forwards to nginx
cache deny all

# Forward decrypted HTTP requests to nginx cache on port 80
# This creates the flow: Client -> Squid (decrypt) -> nginx (cache) -> upstream
cache_peer 127.0.0.1 parent 80 0 no-query originserver name=lancache
cache_peer_access lancache allow all

# Logging
access_log stdio:/data/logs/squid-access.log squid
cache_log /data/logs/squid-cache.log

# PID file location
pid_filename /run/squid/squid.pid

# Coredump directory
coredump_dir /var/spool/squid

# Shutdown timeout
shutdown_lifetime 3 seconds
